// This is your Prisma schema file,
// learn more about in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations
}

// ============================================================================
// User & Authentication
// ============================================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // For password-based auth
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Referral system fields
  referralCode    String?   @unique
  totalEarnings   Decimal   @default(0) @db.Decimal(10, 2)

  // Relations
  assessments     Assessment[]
  journalEntries  JournalEntry[]
  practiceCompletions PracticeCompletion[]
  userProgress    UserProgress[]
  accounts        Account[]
  sessions        Session[]
  resourceClicks  ResourceClick[]
  resourceRatings ResourceRating[]
  resourceComments ResourceComment[]
  challengeEnrollments ChallengeEnrollment[]
  abTestAssignments ABTestAssignment[]

  // Referral relations
  referralsGiven  UserReferral[]  @relation("Referrer")
  referralsReceived UserReferral[] @relation("Referred")
  conversions     AffiliateConversion[]
  payouts         AffiliatePayout[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// Assessment System
// ============================================================================

model Assessment {
  id          String   @id @default(cuid())
  userId      String
  completedAt DateTime @default(now())

  // Assessment responses (JSON)
  responses   Json     // { q1: 4, q2: "scenario-choice", q3: {...} }

  // Assessment result (JSON)
  result      Json     @default("{}") // { overall, domains: {cognitive, interpersonal, self}, stage, vectors }

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("assessments")
}

// ============================================================================
// Meta-Skills & Content (with Translation Tables)
// ============================================================================

model MetaSkill {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "critical-thinking"

  // Immutable properties (not translated)
  domain      Domain   // COGNITIVE, INTERPERSONAL, SELF
  stage       Int      // 1-5
  order       Int      // For sorting within domain

  // JSON metadata (kept for flexibility)
  lifeApplications Json @default("[]") // Application examples

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  translations MetaSkillTranslation[]
  practices   Practice[]
  userProgress UserProgress[]

  @@index([domain, order])
  @@map("meta_skills")
}

model MetaSkillTranslation {
  id          String   @id @default(cuid())

  // Foreign key
  skillId     String
  skill       MetaSkill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  // Locale and status
  locale      String   // 'en', 'zh-CN', 'de', etc.
  status      TranslationStatus @default(DRAFT)

  // Translatable content
  title       String
  description String   @db.Text
  definition  String   @db.Text
  whyImportant String  @db.Text

  // SEO content
  metaTitle       String?
  metaDescription String?  @db.Text
  ogTitle         String?
  ogDescription   String?  @db.Text

  // Workflow tracking
  translatedBy String?  // User ID or translator name
  reviewedBy   String?
  approvedAt   DateTime?
  publishedAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([skillId, locale])
  @@index([locale, status])
  @@index([status, publishedAt])
  @@map("meta_skill_translations")
}

enum Domain {
  COGNITIVE
  INTERPERSONAL
  SELF
}

enum TranslationStatus {
  DRAFT       // Translation in progress
  PENDING     // Awaiting review
  REVIEWED    // Reviewed, awaiting approval
  PUBLISHED   // Live
  ARCHIVED    // Old version
}

model Practice {
  id          String   @id @default(cuid())

  skillId     String
  skill       MetaSkill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  // Immutable metadata
  duration    Int      // in minutes
  difficulty  Difficulty
  emotionTone Emotion
  order       Int      @default(0)

  // Relations
  translations PracticeTranslation[]
  completions PracticeCompletion[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([skillId, difficulty])
  @@map("practices")
}

model PracticeTranslation {
  id          String   @id @default(cuid())

  practiceId  String
  practice    Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  locale      String
  status      TranslationStatus @default(DRAFT)

  // Translatable content
  title       String
  description String   @db.Text
  instructions Json    // Step-by-step instructions
  benefits    String[] // Array of benefits
  tips        String[] // Array of tips

  // Workflow
  translatedBy String?
  reviewedBy   String?
  approvedAt   DateTime?
  publishedAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([practiceId, locale])
  @@index([locale, status])
  @@map("practice_translations")
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum Emotion {
  CALM
  ENERGIZING
  REFLECTIVE
  CHALLENGING
}

// ============================================================================
// Articles with Translations
// ============================================================================

model Article {
  id          String   @id @default(cuid())

  slug        String   @unique
  type        ArticleType
  skillCode   String?

  // Non-translated metadata
  authorName  String
  authorTitle String
  authorImage String?
  coverImage  String?
  category    String?

  views       Int      @default(0)
  likes       Int      @default(0)

  isPublished Boolean  @default(true) // Master publication switch
  publishedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  translations ArticleTranslation[]

  @@index([type, skillCode, isPublished])
  @@index([slug])
  @@map("articles")
}

model ArticleTranslation {
  id          String   @id @default(cuid())

  articleId   String
  article     Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  locale      String
  status      TranslationStatus @default(DRAFT)

  // Translatable content
  title       String
  content     String   @db.Text
  excerpt     String   @db.Text

  // SEO
  metaTitle       String?
  metaDescription String?  @db.Text
  ogTitle         String?
  ogDescription   String?  @db.Text

  // Locale-specific publication
  isPublished Boolean  @default(false)
  publishedAt  DateTime?

  // Workflow
  translatedBy String?
  reviewedBy   String?
  approvedAt   DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([articleId, locale])
  @@index([locale, status, isPublished])
  @@map("article_translations")
}

enum ArticleType {
  EXPERT_INTERVIEW
  LEARNING_INSIGHTS
  SUCCESS_STORY
  RESEARCH_SUMMARY
}

// ============================================================================
// User Progress & Journal
// ============================================================================

model UserProgress {
  id          String   @id @default(cuid())
  userId      String
  skillId     String

  // Current stage (1-5)
  stage       Int      @default(1)

  // 4D Vector scores
  awareness   Float    @default(0)
  stability   Float    @default(0)
  practice    Float    @default(0)
  growth      Float    @default(0)

  // Metadata
  lastAssessedAt DateTime?
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill       MetaSkill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@map("user_progress")
}

model JournalEntry {
  id          String   @id @default(cuid())
  userId      String

  // Content
  title       String?
  content     String   @db.Text
  mood        Int?     // 1-10 mood score

  // Skill associations (JSON array of skill IDs)
  associatedSkills Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("journal_entries")
}

model PracticeCompletion {
  id          String   @id @default(cuid())
  userId      String
  practiceId  String

  completedAt DateTime @default(now())
  notes       String?  @db.Text
  rating      Int?     // 1-5 user rating

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  practice    Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@map("practice_completions")
}

// ============================================================================
// Resource Recommendations
// ============================================================================

model ResourceClick {
  id          String   @id @default(cuid())
  userId      String

  // Resource details
  resourceType ResourceType
  resourceTitle String
  resourceUrl   String
  skillCode     String

  // Click context
  clickSource  ClickSource
  metadata     Json?

  clickedAt   DateTime @default(now())

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, skillCode])
  @@index([resourceType, clickedAt])
  @@map("resource_clicks")
}

enum ResourceType {
  BOOK
  TOOL
  COURSE
  ARTICLE
  VIDEO
}

enum ClickSource {
  SKILL_PAGE
  PRACTICE_MODAL
  DASHBOARD
  RECOMMENDATION_EMAIL
}

// ============================================================================
// Resource Ratings & Comments
// ============================================================================

model ResourceRating {
  id          String   @id @default(cuid())
  userId      String

  resourceType ResourceType
  resourceUrl  String
  skillCode    String

  rating       Int      // 1-5 stars
  review       String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceUrl])
  @@index([resourceUrl, rating])
  @@index([skillCode, resourceType])
  @@map("resource_ratings")
}

model ResourceComment {
  id          String   @id @default(cuid())
  userId      String

  resourceType ResourceType
  resourceUrl  String
  skillCode    String

  content     String   @db.Text

  parentId    String?
  parent      ResourceComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     ResourceComment[] @relation("CommentReplies")

  likes       Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([resourceUrl, createdAt])
  @@index([skillCode, resourceType])
  @@map("resource_comments")
}

// ============================================================================
// Resource Challenges
// ============================================================================

model Challenge {
  id          String   @id @default(cuid())

  title       String
  description String   @db.Text
  type        ChallengeType

  targetCount Int
  timeframe   Int
  skillCode   String?

  badgeUrl    String?
  badgeTitle  String?

  isActive    Boolean  @default(true)
  startDate   DateTime?
  endDate     DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  enrollments ChallengeEnrollment[]

  @@index([type, isActive])
  @@index([skillCode])
  @@map("challenges")
}

model ChallengeEnrollment {
  id          String   @id @default(cuid())
  userId      String
  challengeId String

  startedAt   DateTime @default(now())
  completedAt DateTime?
  progress    Int      @default(0)
  resourceUrls String[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@index([userId, completedAt])
  @@map("challenge_enrollments")
}

enum ChallengeType {
  READING_CHALLENGE
  SKILL_MASTERY
  TOOL_EXPLORATION
  LEARNING_STREAK
}

// ============================================================================
// A/B Testing System
// ============================================================================

model ABTest {
  id          String   @id @default(cuid())

  name        String
  description String?  @db.Text
  isActive    Boolean  @default(true)

  trafficAllocation Int @default(50)
  startDate   DateTime @default(now())
  endDate     DateTime?

  testType    TestType
  testContext String

  variantA    Json
  variantB    Json

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments ABTestAssignment[]

  @@index([isActive, startDate])
  @@index([testType, testContext])
  @@map("ab_tests")
}

model ABTestAssignment {
  id          String   @id @default(cuid())
  userId      String?

  testId      String
  test        ABTest   @relation(fields: [testId], references: [id], onDelete: Cascade)

  variant     String

  sessionId   String?
  assignedAt  DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversions ABTestConversion[]

  @@index([testId, variant])
  @@index([userId, testId])
  @@map("ab_test_assignments")
}

model ABTestConversion {
  id          String   @id @default(cuid())

  assignmentId String
  assignment   ABTestAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  conversionType ConversionType
  resourceUrl   String?
  metadata      Json?

  convertedAt  DateTime @default(now())

  @@index([assignmentId, conversionType])
  @@index([conversionType, convertedAt])
  @@map("ab_test_conversions")
}

enum TestType {
  RESOURCE_LAYOUT
  CTA_POSITION
  THUMBNAIL_SIZE
  CARD_ORIENTATION
  DESCRIPTION_LENGTH
}

enum ConversionType {
  CLICK
  VIEW
  RATE
  COMMENT
  ENGAGEMENT
}

// ============================================================================
// Affiliate & Referral System
// ============================================================================

model UserReferral {
  id            String        @id @default(cuid())
  referrerId    String
  referrer      User          @relation("Referrer", fields: [referrerId], references: [id])
  referredId    String        @unique
  referred      User          @relation("Referred", fields: [referredId], references: [id])

  referralCode  String        @unique
  status        ReferralStatus @default(PENDING)
  commissionRate Decimal      @default(30.00) @db.Decimal(4, 2)

  createdAt     DateTime      @default(now())
  activatedAt   DateTime?

  conversions   AffiliateConversion[]

  @@index([referrerId, status])
  @@index([referralCode])
  @@map("user_referrals")
}

model AffiliateConversion {
  id            String        @id @default(cuid())
  userId        String?
  user          User?         @relation(fields: [userId], references: [id])

  resourceUrl   String
  resourceType  ResourceType
  asin          String?

  referralCode  String?
  referral      UserReferral? @relation(fields: [referralCode], references: [referralCode])

  clickId       String?       // UUID for tracking

  converted     Boolean       @default(false)
  orderId       String?
  commissionAmount Decimal?    @db.Decimal(10, 2)
  userShare     Decimal?      @db.Decimal(10, 2)
  platformShare Decimal?      @db.Decimal(10, 2)

  clickedAt     DateTime      @default(now())
  convertedAt   DateTime?
  reportedAt    DateTime?

  metadata      Json?

  @@index([userId, clickedAt])
  @@index([referralCode, converted])
  @@index([asin, converted])
  @@map("affiliate_conversions")
}

model AffiliatePayout {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id])

  amount        Decimal       @db.Decimal(10, 2)
  status        PayoutStatus  @default(PENDING)

  payoutMethod  String?       // paypal, bank_transfer, alipay, wechat
  payoutDetails Json?

  requestedAt   DateTime      @default(now())
  processedAt   DateTime?
  paidAt        DateTime?

  transactionId String?
  notes         String?       @db.Text
  metadata      Json?

  @@index([userId, status])
  @@index([status, requestedAt])
  @@map("affiliate_payouts")
}

enum ReferralStatus {
  PENDING    // Just registered, haven't made first purchase
  ACTIVE     // Activated (made first purchase or completed action)
  COMPLETED  // Relationship ended (optional)
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}
